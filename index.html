<!DOCTYPE html>
<meta charset="utf-8" />
<html>
  <head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-array.v2.min.js"></script>
    <script src="js/setChart.js"></script>

    <style>
      body {
        font: 1rem sans-serif;
        margin: 4px 20px 0px 20px;
        background-color: white;
      }

      table {
        width: 100%;
      }

      #logo {
        text-align: right;
      }
    </style>
  </head>
  <body>
    <table>
      <tr>
        <td>
          <h2>Visual Analysis of Program Committee Service for Selected Conferences</h2>
          <strong>Data:</strong> <a download href="data/confPC_v3.csv">confPC_v3.csv</a><br/><br/>

          <strong>Author:</strong> <a href="https://csteed.com" target="_blank">Chad A. Steed</a>, <a href="https://vis.ornl.gov" target="_blank">VISTA Lab</a>, <a href="https://www.ornl.gov/division/csmd" target="_blank">Computer Science and Mathematics Division</a>, <a href="https://ornl.gov" target="_blank">Oak Ridge National Laboratory</a>
          <br/>
          <strong>Collaborators:</strong> Erik Schmidt (ORNL), Devesh Tiwari (Notheastern), Arthur "Barney" Maccabe (ORNL)
        </td>

        <td id="logo"><a href="https://vis.ornl.gov/" target="_blank"><img src="img/vista-logo.png" height=70 alt="ORNL VISTA Vis Lab"></img></a></td>
      </tr>
    </table>
    <h3>Chart Controls:</h3>
    <p>
      <label for="yearSelect">Year: </label>
      <select id="yearSelect" onChange="yearSelectChanged()"></select>
      <br/><br/>

      <label for="sortOptionSelect">Sorting Option: </label>
      <select id="sortOptionSelect" onChange="sortOptionSelectChanged()">
        <option selected>Activeness</option>
        <option>Conference</option>
        <option>Name</option>
      </select>
      <br/><br/>

      <label for="searchTextField">Filter by Name: </label>
      <input id="searchTextField" type="text"></input>
      <label>(partial name search; use commas for multiple names)</label>
      <br/><br/>
    </p>

    <div id="chart"></div>
    <br/><br/>
    <center>
      <h4>&copy; <a href="https://www.ornl.gov">Oak Ridge National Laboratory</a>
          <script type="text/javascript">
              document.write(new Date().getFullYear());
          </script>
      </h4>
    </center>
    <br/>
    <br/>
  </body>

  <script>
    const chartMargin = {top:100, right:20, bottom:20, left:160};
    let chartData;
    let chart;
    let confNames;

    const nameSearchTextInputHandler = () => {
      if (chart) {
        const textValue = document.getElementById('searchTextField').value;
        chart.setNameFilterStrings(textValue);
      }
    };

    document.getElementById('searchTextField').addEventListener('input', nameSearchTextInputHandler);

    const populateYearSelect = () => {
      const select = document.getElementById('yearSelect');
      for (let i = select.options.length; i >= 0; i--) {
        select.remove(i);
      }
      const years = [...new Set(chartData.map(d => d.Year))].sort(d3.descending);
      // console.log(years);
      select.options[0] = new Option('All Years');
      years.map(d => {
        select.options[select.options.length] = new Option(d);
      });
    };

    const getSelectedYear = () => {
      const select = document.getElementById('yearSelect');
      return select.options[select.selectedIndex].text;
    }

    const yearSelectChanged = () => {
      createChart();
    };

    const getSelectedSortOption = () => {
      const select = document.getElementById('sortOptionSelect');
      let option = select.options[select.selectedIndex].text;
      return option === 'Conference' ? 'Set' : option;
    }
    
    const sortOptionSelectChanged = () => {
      // console.log('sort options CHANGED');
      let sortOption = getSelectedSortOption();
      // sortOption = sortOption === 'Conference' ? 'Set' : sortOption;
      chart.sortOption(sortOption);
    }

    const loadData = () => {
      let selectedYear = getSelectedYear();
      // console.log(selectedYear);
      let filteredData;
      if (selectedYear === 'All Years') {
        // merge names for multiple years into a single entry for each name
        const names = [...new Set(chartData.map(d => d.Name))];
        // console.log(names);
        filteredData = names.map(name => {
          nameItems = chartData.filter(d => d.Name === name);
          if (name.search("Ethan") !== -1) { 
            console.log(nameItems);
            // console.log(mergedItem);
          }
          if (nameItems.length > 1) {
            let mergedItem = {
              Name: name
            };
            confNames.map(confName => {
              nameItems.map(item => {
                mergedItem[confName] = mergedItem[confName] === 1 || item[confName] === 1 ? 1 : 0;
              });
            });
            
            return mergedItem;
          } else {
            return nameItems[0];
          }
        });
      } else {
        // filter based on current selected year
        selectedYear = +selectedYear;
        filteredData = chartData.filter(d => d.Year === selectedYear);
      }
      // console.log(filteredData);
      
      return filteredData;
    }

    const createChart = () => {
      if (chartData) {
        data = loadData();
        const selectedSortOption = getSelectedSortOption();
        const nameFilterText = document.getElementById('searchTextField').value;
        const chartWidth = document.getElementById('chart').clientWidth;
        chart = setChart()
          .margin(chartMargin)
          .boxSize(20)
          .sortOption(selectedSortOption)
          .nameValue(d => d.Name)
          .setNameFilterStrings(nameFilterText)
          .setNames(confNames);
        d3.select('#chart').call(chart, data);
      }
    }

    d3.csv("data/confPC_v3.csv", d3.autoType)
      .then(data => {
        // console.log(data);
        confNames = data.columns.filter(d => d !== 'Name' && d !== 'Year')
        // console.log(confNames);
        chartData = data;
        // chartData = data.filter(d => d.Year === 2020);
        console.log(chartData);
        // columnCategories = new Map();
        // // data = data.filter(d => d.Year === 2020)
        // // console.log(data);

        // data.columns.forEach(column => {
        //   if (column !== 'Name') {
        //     let conf = column.substring(0, column.indexOf(','));
        //     console.log(conf);
        //     let confColumns = columnCategories.get(conf);
        //     if (!confColumns) {
        //       confColumns = [];
        //       columnCategories.set(conf, confColumns);
        //     }
        //     confColumns.push(column);
        //   }
        // });
        // console.log(columnCategories);
        // console.log(columnCategories.keys());

        // chartData = [];
        // data.forEach(d => {
        //   confRollups = new Map();
        //   columnCategories.forEach((value, key) => {
        //     let inConf = false;
        //     value.forEach(v => {
        //       if (d[v] === 1) {
        //         inConf = true;
        //       }
        //     });
        //     confRollups.set(key, inConf);
        //     // console.log(`key: ${key}  value: ${value}`);
        //   });
        //   chartDatum = {Name: d.Name}
        //   // console.log(confRollups);
        //   confRollups.forEach((value, key) => {
        //     chartDatum[key] = value;
        //   })
        //   chartData.push(chartDatum);
        // })
        // // chartData = data;
        // confNames = [...columnCategories.keys()];
        // console.log(confNames);
        // console.log(chartData);
        populateYearSelect();
        createChart();
      })
      .catch(error => {
        console.log(error);
      })

  </script>
</html>